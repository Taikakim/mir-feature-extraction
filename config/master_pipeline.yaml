# Master Pipeline Configuration
# Copy this file and customize for your project
#
# Usage:
#   python src/master_pipeline.py --config config/my_project.yaml
#   python src/master_pipeline.py --config config/my_project.yaml --overwrite  # CLI overrides config

# =============================================================================
# PATHS
# =============================================================================
paths:
  input: null                    # Required: Input directory (raw audio or organized)
  output: null                   # Output directory for organized files (null = in-place)
  stems_source: null             # Pre-existing stems directory (skips Demucs if set)

# =============================================================================
# STAGE CONTROL
# =============================================================================
stages:
  organize: true                 # Stage 1: Organize raw files into project structure
  track_analysis: true           # Stage 2: Full track analysis (Demucs, beats, metadata)
  cropping: true                 # Stage 3: Create training crops
  crop_analysis: true            # Stage 4: Analyze crops (features + AI descriptions)

# =============================================================================
# DEMUCS STEM SEPARATION
# =============================================================================
demucs:
  # Available models:
  #   htdemucs      - Hybrid Transformer Demucs (default, fast)
  #   htdemucs_ft   - Fine-tuned htdemucs (4x slower, slightly better quality)
  #   htdemucs_6s   - 6-source model (adds piano + guitar stems)
  #   mdx_extra     - MDX-Net based model
  #   mdx_extra_q   - Quantized MDX-Net (smaller, faster)
  model: htdemucs                # Default: htdemucs (good balance of speed/quality)

  shifts: 0                      # Random shifts (0=fast for MIR, 1+=hifi quality)
  device: cuda                   # cuda, cpu, mps

  # Segment length in seconds - controls GPU memory usage
  # NOTE: Maximum segment depends on model! htdemucs max is ~7.8s
  #   htdemucs:    max 7.8s (trained segment length)
  #   htdemucs_ft: max 7.8s
  #   mdx_extra:   longer segments supported
  # Set to null to use model's default (recommended)
  segment: null                  # Segment length in seconds (null = model default, recommended)

  output_format: mp3             # mp3 (default, VBR), flac, wav, wav24, wav32, ogg
  mp3_bitrate: 128               # MP3 bitrate (64-320) if format=mp3
  clip_mode: rescale             # rescale or clamp

  # Parallel processing (subprocess-based, each worker ~5GB VRAM)
  # Each worker runs a separate Demucs process for true parallel GPU utilization
  # 2 workers: ~10GB VRAM, ~1.7x speedup
  # 4 workers: ~20GB VRAM (requires high VRAM GPU)
  workers: 4                     # Parallel workers for batch processing

# =============================================================================
# RHYTHM ANALYSIS
# =============================================================================
rhythm:
  # Beat detection uses madmom by default
  # These features are extracted for full tracks and migrated to crops
  enabled: true
  workers: 8                     # Parallel workers for beat/downbeat detection

# =============================================================================
# CROPPING
# =============================================================================
cropping:
  length_samples: 2097152        # Crop length in SAMPLES (2097152 = ~47.5s at 44.1kHz)
                                 # Common values:
                                 #   1323000  = ~30.0s at 44.1kHz
                                 #   2097152  = ~47.5s at 44.1kHz (default)
                                 #   2646000  = ~60.0s at 44.1kHz

  mode: beat-aligned               # sequential or beat-aligned
  overlap: false                 # 50% overlap between crops
  div4: true                    # Ensure downbeats divisible by 4 (beat-aligned mode)
  include_stems: true            # Also crop stems alongside full mix
  workers: 10                     # Parallel workers for cropping

# =============================================================================
# FEATURE EXTRACTION
# =============================================================================
features:
  # Loudness (LUFS/LRA)
  loudness: true

  # Spectral features (flatness, flux, skewness, kurtosis)
  spectral: true

  # Multiband RMS (bass, body, mid, air)
  multiband_rms: true

  # Harmonic/Chroma (12-bin pitch class)
  chroma: true

  # Timbral (Audio Commons: brightness, roughness, hardness, etc.)
  timbral: true

  # Essentia classification (danceability, genre, mood, instruments)
  essentia: true

  # AudioBox aesthetics (content enjoyment, production quality, etc.)
  audiobox: true

  # Per-stem features (requires stems)
  per_stem: true

# =============================================================================
# PER-FEATURE OVERWRITE CONTROL
# =============================================================================
# By default, existing features are NOT overwritten. Set individual keys to true
# to force regeneration of specific features even if they already exist.
# These override the global processing.overwrite setting.
overwrite:
  demucs: false                  # Overwrite existing stem separations
  beats: false                   # Overwrite existing beat grids
  bpm: false                     # Overwrite existing BPM data
  crops: false                   # Overwrite existing training crops
  loudness: false                # Overwrite existing loudness data
  spectral: false                # Overwrite existing spectral features
  multiband_rms: false           # Overwrite existing multiband RMS data
  chroma: false                  # Overwrite existing chroma features
  timbral: false                 # Overwrite existing timbral features
  essentia: false                # Overwrite existing Essentia classification
  audiobox: false                # Overwrite existing AudioBox aesthetics
  per_stem_rhythm: false         # Overwrite existing per-stem rhythm features
  per_stem_harmonic: false       # Overwrite existing per-stem harmonic features
  music_flamingo: false          # Overwrite existing AI descriptions
  metadata: false                # Overwrite existing metadata lookups

# =============================================================================
# MUSIC FLAMINGO (AI Descriptions)
# =============================================================================
music_flamingo:
  enabled: true
  model: Q8_0                    # IQ3_M (fast), Q6_K (balanced), Q8_0 (best quality)

  # Prompt types to generate (all enabled by default)
  prompts:
    full: true                   # Comprehensive description
    technical: true              # Tempo, key, chords, dynamics
    genre_mood: true             # Genre and emotional character
    instrumentation: true        # Instruments and sounds
    structure: true              # Arrangement and structure

  # Max tokens per prompt type (higher = longer descriptions, more VRAM)
  max_tokens:
    full: 384
    technical: 256
    genre_mood: 256
    instrumentation: 256
    structure: 256

# =============================================================================
# METADATA LOOKUP
# =============================================================================
# Priority order for artist identification:
#   1. ID3 tags (if valid artist exists, no fingerprinting needed)
#   2. Folder name (if valid artist exists, no fingerprinting needed)  
#   3. AcoustID fingerprinting (ONLY as last resort when both above fail)
metadata:
  enabled: true
  use_fingerprinting: true       # Enable AcoustID fingerprinting as LAST RESORT only
                                 # (only used when ID3 tags AND folder name lack valid artist)
  fix_various_artists: true      # Fix "Various Artists" names during file organization
                                 # Uses ID3 tags first, then Spotify/MusicBrainz lookup

  # Artists that trigger metadata lookup (case-insensitive)
  various_artists_aliases:
    - various artists
    - various
    - va
    - v/a
    - v.a.
    - compilation
    - unknown artist
    - unknown

# =============================================================================
# FILENAME CLEANUP
# =============================================================================
filename_cleanup:
  enabled: true                  # Clean filenames for T5 tokenizer compatibility
                                 # Converts accented chars to ASCII, normalizes spaces/dashes

# =============================================================================
# PROCESSING OPTIONS
# =============================================================================
processing:
  device: cuda                   # cuda or cpu
  overwrite: false               # Overwrite existing features
  verbose: false                 # Verbose logging
  feature_workers: 10             # Parallel workers for CPU features (loudness, spectral, timbral, etc.)
  essentia_workers: 4            # Separate limit for Essentia (TensorFlow deadlocks with >4-6 workers)
